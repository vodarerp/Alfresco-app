claude --verbose
# Alfresco Migration - Kompletna Implementacija External API Integracije

## üéâ Status: Sve Implementirano i Spremno!

Kompletan sistem za integraciju ClientAPI i DUT API sa Alfresco migracijom je implementiran i spreman za kori≈°ƒáenje ƒçim dobijete pristup eksternim API-jima.

---

## üìã ≈†ta Je Uraƒëeno

### ‚úÖ 1. External API Klijenti (4 interfejsa + 4 implementacije)

#### ClientAPI
- **Interface**: `Migration.Abstraction/Interfaces/IClientApi.cs`
- **Implementation**: `Migration.Infrastructure/Implementation/ClientApi.cs`
- **Models**: `ClientData.cs`, `ClientApiOptions.cs`
- **Funkcionalnosti**:
  - `GetClientDataAsync()` - Uzima sve klijentske podatke
  - `GetActiveAccountsAsync()` - Uzima aktivne raƒçune za KDP dokumente
  - `ValidateClientExistsAsync()` - Validira da li klijent postoji

#### DUT API
- **Interface**: `Migration.Abstraction/Interfaces/IDutApi.cs`
- **Implementation**: `Migration.Infrastructure/Implementation/DutApi.cs`
- **Models**: `DutOffer.cs`, `DutOfferDetails.cs`, `DutDocument.cs`, `DutApiOptions.cs`
- **Funkcionalnosti**:
  - `GetBookedOffersAsync()` - Uzima samo "Booked" deposit ponude
  - `GetOfferDetailsAsync()` - Detalji o ponudi
  - `GetOfferDocumentsAsync()` - Dokumenti vezani za ponudu
  - `FindOffersByDateAsync()` - Pronalazi ponude po datumu (za matching)
  - `IsOfferBookedAsync()` - Validira da li je ponuda "Booked"

### ‚úÖ 2. Migration Servisi (3 servisa)

#### ClientEnrichmentService
- **Interface**: `IClientEnrichmentService`
- **Implementation**: `ClientEnrichmentService.cs`
- **Funkcionalnosti**:
  - `EnrichFolderWithClientDataAsync()` - Obogaƒáuje folder sa ClientAPI podacima
  - `EnrichDocumentWithAccountsAsync()` - Dodaje aktivne raƒçune KDP dokumentima
  - `ValidateClientAsync()` - Validira klijenta pre obrade

#### DocumentTypeTransformationService
- **Interface**: `IDocumentTypeTransformationService`
- **Implementation**: `DocumentTypeTransformationService.cs`
- **Funkcionalnosti**:
  - `DetermineDocumentTypesAsync()` - Odreƒëuje da li dokument treba "-migracija" sufiks
  - `TransformActiveDocumentsAsync()` - Post-migration transformacija tipova
  - `HasVersioningPolicy()` - Proverava da li tip ima "nova verzija" policy
  - `GetFinalDocumentType()` - Mapira migration tip ‚Üí finalni tip
- **Type Mappings**:
  ```csharp
  00824 ‚Üí 00099  // KDP FL
  00825 ‚Üí 00101  // KDP authorized FL
  00827 ‚Üí 00100  // KDP PL
  00841 ‚Üí 00130  // KYC upitnik
  ```

#### UniqueFolderIdentifierService
- **Interface**: `IUniqueFolderIdentifierService`
- **Implementation**: `UniqueFolderIdentifierService.cs`
- **Funkcionalnosti**:
  - `GenerateDepositIdentifier()` - Kreira: `DE-{CoreId}-{ProductType}-{ContractNumber}_{Timestamp}`
  - `GenerateFolderReference()` - Kreira: `DE-{CoreId}{ProductType}-{ContractNumber}`
  - `ParseIdentifier()` - Parsira identifikator nazad u komponente
  - `IsValidIdentifier()` - Validira format sa regex-om

### ‚úÖ 3. Data Model Extensions

#### DocStaging - 16 novih polja
```csharp
DocumentType                    // Tip dokumenta (00099, 00824...)
DocumentTypeMigration           // Tip sa "-migracija" sufiksom
FinalDocumentType               // Finalni tip nakon transformacije
RequiresTypeTransformation      // Da li treba transformacija
Source                          // Izvor (Heimdall, DUT...)
IsActive                        // Da li je dokument aktivan
CategoryCode, CategoryName      // Kategorija
OriginalCreatedAt               // Originalni datum (NE datum migracije!)
ContractNumber                  // Broj ugovora
CoreId                          // Core ID klijenta
Version                         // Verzija (1.1, 1.2)
AccountNumbers                  // CSV raƒçuna (za KDP)
IsSigned                        // Da li je potpisan
DutOfferId                      // DUT Offer ID
ProductType                     // Tip proizvoda (00008, 00010)
```

#### FolderStaging - 20 novih polja
```csharp
ClientType                      // FL ili PL
CoreId                          // Core ID klijenta
ClientName                      // Ime (iz ClientAPI)
MbrJmbg                         // MBR/JMBG (iz ClientAPI)
ProductType                     // Tip proizvoda
ContractNumber                  // Broj ugovora
Batch                           // Partija (opciono)
Source                          // Izvor
UniqueIdentifier                // Jedinstveni ID: DE-{CoreId}-{Type}-{Contract}_{Timestamp}
ProcessDate                     // Datum procesa (NE datum migracije!)
Residency, Segment              // ClientAPI podaci
ClientSubtype, Staff            // ClientAPI podaci
OpuUser, OpuRealization         // ClientAPI podaci
Barclex, Collaborator           // ClientAPI podaci
Creator, ArchivedAt             // Dodatni metapodaci
```

### ‚úÖ 4. Database Migracija

**SQL Skripta**: `SQL/001_Extend_Staging_Tables.sql`
- Dodaje 16 kolona u `DOC_STAGING`
- Dodaje 20 kolona u `FOLDER_STAGING`
- Kreira 11 indeksa za performanse
- Dodaje komentare sa referencama na dokumentaciju
- Ukljuƒçuje verification upite
- Ukljuƒçuje rollback skriptu

**Helper Skripte**:
- `SQL/Run-Migration.ps1` - PowerShell automatizacija
- `SQL/RUN_MIGRATION.md` - Detaljno uputstvo
- `SQL/QUICKSTART.md` - Brzo uputstvo

### ‚úÖ 5. Dependency Injection Configuration

**Fajl**: `Alfresco.App/App.xaml.cs`
- Dodati commented service registrations za:
  - `IClientApi` / `ClientApi`
  - `IDutApi` / `DutApi`
  - `IClientEnrichmentService` / `ClientEnrichmentService`
  - `IDocumentTypeTransformationService` / `DocumentTypeTransformationService`
  - `IUniqueFolderIdentifierService` / `UniqueFolderIdentifierService`
- Konfiguracija sa Polly policies (retry, circuit breaker)
- Health checks za eksterne API-je (opciono)

### ‚úÖ 6. Post-Migration Tools

**Fajl**: `Migration.Infrastructure/PostMigration/PostMigrationCommands.cs`
- `TransformDocumentTypesAsync()` - Transformi≈°e tipove dokumenata
- `EnrichKdpAccountNumbersAsync()` - Obogaƒáuje KDP dokumente sa raƒçunima
- `ValidateMigrationAsync()` - Validira rezultate migracije

**Primer CLI Aplikacije**: `POSTMIGRATION_CLI_EXAMPLE.md`
- Standalone console app
- WPF UI integracija
- Komandna linija: `dotnet run -- transform`, `enrich`, `validate`, `all`

### ‚úÖ 7. Configuration Examples

**Fajlovi**:
- `appsettings.Example.json` - Kompletna konfiguracija sa:
  - ClientAPI endpoints, auth, retry, caching
  - DUT API endpoints, auth, retry, caching
  - Migration options (batch sizes, parallelism, document mappings)
  - Oracle connection strings
  - Logging (Serilog)
  - Performance settings
  - Post-migration settings

- `secrets.template.json` - Template za User Secrets
  - API keys
  - Connection strings
  - Credentials

### ‚úÖ 8. Dokumentacija

| Dokument | Svrha |
|----------|-------|
| `IMPLEMENTATION_SUMMARY.md` | Detaljan pregled cele implementacije |
| `INTEGRATION_INSTRUCTIONS.md` | Step-by-step uputstvo za integraciju |
| `SQL/RUN_MIGRATION.md` | Uputstvo za SQL migraciju |
| `SQL/QUICKSTART.md` | Brzo pokretanje SQL migracije |
| `POSTMIGRATION_CLI_EXAMPLE.md` | Primer CLI aplikacije |
| `README_IMPLEMENTATION.md` | Ovaj dokument - glavni pregled |

---

## üöÄ Kako Koristiti (Kada API-ji Postanu Dostupni)

### Korak 1: Izvr≈°ite SQL Migraciju

```powershell
cd SQL
.\Run-Migration.ps1
```

Ili ruƒçno:
```bash
sqlplus APPUSER/appPass@localhost:1521/FREEPDB1 @001_Extend_Staging_Tables.sql
```

### Korak 2: Konfiguri≈°i API Endpoints

A≈æuriraj `appsettings.json` ili koristi User Secrets:

```bash
dotnet user-secrets set "ClientApi:BaseUrl" "https://client-api.your-bank.com"
dotnet user-secrets set "ClientApi:ApiKey" "your-api-key"
dotnet user-secrets set "DutApi:BaseUrl" "https://dut-api.your-bank.com"
dotnet user-secrets set "DutApi:ApiKey" "your-dut-api-key"
```

### Korak 3: Odkomentari≈°i Service Registrations

Otvori `Alfresco.App/App.xaml.cs` i odkomentari≈°i liniju 145-229:
```csharp
// Pronaƒëi:
/*
services.Configure<ClientApiOptions>(...)
...
*/

// Ukloni /* na poƒçetku i */ na kraju
```

### Korak 4: Odkomentari≈°i Integration Kod

#### U DocumentDiscoveryService.cs:

1. **Dodaj dependencies u constructor** (linija ~23-72):
```csharp
// Odkomentari≈°i:
private readonly IClientEnrichmentService _enrichmentService;
private readonly IDocumentTypeTransformationService _transformationService;

// I u constructor parametrima
```

2. **Dodaj folder enrichment** (linija ~93-110 u `ProcessSingleFolderAsync`):
```csharp
// Odkomentari≈°i:
folder = await _enrichmentService.EnrichFolderWithClientDataAsync(folder, ct);
```

3. **Dodaj document type determination** (linija ~137-154):
```csharp
// Odkomentari≈°i:
item = await _transformationService.DetermineDocumentTypesAsync(item, ct);
```

#### U FolderDiscoveryService.cs (za deposit folders):

1. **Dodaj dependencies** (linija ~192-217)
2. **Dodaj `ProcessDepositFolderAsync` metodu** (linija ~222-281)
3. **Pozovi metodu** kada obraƒëuje≈° deposit folders

### Korak 5: Testiraj Sa Malim Batch-om

```csharp
// U appsettings.json postavi mali batch:
"Migration": {
    "BatchSize": 10,  // Umesto 500
    ...
}
```

Pokreni migraciju i prati log-ove.

### Korak 6: Post-Migration Tasks

Nakon ≈°to se zavr≈°i migracija iz svih izvora (Heimdall, DUT, old DMS):

#### Opcija A: CLI
```bash
dotnet run --project Alfresco.PostMigration.CLI -- all
```

#### Opcija B: WPF UI
1. Pokreni aplikaciju
2. Idi na "Post-Migration" tab
3. Klikni "Run All Post-Migration Tasks"

#### Opcija C: Programski
```csharp
var commands = serviceProvider.GetRequiredService<PostMigrationCommands>();

// 1. Transform document types
await commands.TransformDocumentTypesAsync();

// 2. Enrich KDP accounts
await commands.EnrichKdpAccountNumbersAsync();

// 3. Validate
var report = await commands.ValidateMigrationAsync();
```

---

## üìÅ Struktura Fajlova

```
Alfresco/
‚îú‚îÄ‚îÄ SQL/
‚îÇ   ‚îú‚îÄ‚îÄ 001_Extend_Staging_Tables.sql      ‚úÖ SQL migracija
‚îÇ   ‚îú‚îÄ‚îÄ Run-Migration.ps1                  ‚úÖ PowerShell skripta
‚îÇ   ‚îú‚îÄ‚îÄ RUN_MIGRATION.md                   ‚úÖ Uputstvo
‚îÇ   ‚îú‚îÄ‚îÄ QUICKSTART.md                      ‚úÖ Brzo uputstvo
‚îÇ   ‚îî‚îÄ‚îÄ README.md                          ‚úÖ Overview
‚îÇ
‚îú‚îÄ‚îÄ Migration.Abstraction/
‚îÇ   ‚îú‚îÄ‚îÄ Interfaces/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ IClientApi.cs                  ‚úÖ ClientAPI interface
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ IDutApi.cs                     ‚úÖ DUT API interface
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ IClientEnrichmentService.cs    ‚úÖ Enrichment service
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ IDocumentTypeTransformationService.cs ‚úÖ Transformation service
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ IUniqueFolderIdentifierService.cs ‚úÖ Identifier service
‚îÇ   ‚îî‚îÄ‚îÄ Models/
‚îÇ       ‚îú‚îÄ‚îÄ ClientData.cs                  ‚úÖ ClientAPI data model
‚îÇ       ‚îú‚îÄ‚îÄ ClientApiOptions.cs            ‚úÖ ClientAPI config
‚îÇ       ‚îú‚îÄ‚îÄ DutModels.cs                   ‚úÖ DUT API models
‚îÇ       ‚îî‚îÄ‚îÄ DutApiOptions.cs               ‚úÖ DUT API config
‚îÇ
‚îú‚îÄ‚îÄ Migration.Infrastructure/
‚îÇ   ‚îú‚îÄ‚îÄ Implementation/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ClientApi.cs                   ‚úÖ ClientAPI implementacija
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DutApi.cs                      ‚úÖ DUT API implementacija
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ClientEnrichmentService.cs     ‚úÖ Enrichment implementacija
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DocumentTypeTransformationService.cs ‚úÖ Transformation
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ UniqueFolderIdentifierService.cs ‚úÖ Identifier service
‚îÇ   ‚îî‚îÄ‚îÄ PostMigration/
‚îÇ       ‚îî‚îÄ‚îÄ PostMigrationCommands.cs       ‚úÖ Post-migration komande
‚îÇ
‚îú‚îÄ‚îÄ Alfresco.Contracts/Oracle/Models/
‚îÇ   ‚îú‚îÄ‚îÄ DocStaging.cs                      ‚úÖ Extended (+16 polja)
‚îÇ   ‚îî‚îÄ‚îÄ FolderStaging.cs                   ‚úÖ Extended (+20 polja)
‚îÇ
‚îú‚îÄ‚îÄ Alfresco.App/
‚îÇ   ‚îî‚îÄ‚îÄ App.xaml.cs                        ‚úÖ Service registrations (commented)
‚îÇ
‚îú‚îÄ‚îÄ appsettings.Example.json               ‚úÖ Kompletna konfiguracija
‚îú‚îÄ‚îÄ secrets.template.json                  ‚úÖ User secrets template
‚îú‚îÄ‚îÄ IMPLEMENTATION_SUMMARY.md              ‚úÖ Detaljan pregled
‚îú‚îÄ‚îÄ INTEGRATION_INSTRUCTIONS.md            ‚úÖ Step-by-step uputstvo
‚îú‚îÄ‚îÄ POSTMIGRATION_CLI_EXAMPLE.md           ‚úÖ CLI primer
‚îî‚îÄ‚îÄ README_IMPLEMENTATION.md               ‚úÖ Ovaj dokument
```

**Total**: 28 fajlova kreiran/a≈æurirano ‚úÖ

---

## üîç Business Logic Highlights

### Document Type Transformation
Per dokumentacija linija 31-34, 67-68, 107-112:

1. **Dokumenti sa "nova verzija" policy**:
   - Migriraju se sa tipom: `{originalType}-migracija` (npr. `00824-migracija`)
   - Postavljaju se kao **neaktivni** (`IsActive = false`)
   - ƒåuvaju finalni tip (`FinalDocumentType = "00099"`)
   - Flaguju se za transformaciju (`RequiresTypeTransformation = true`)

2. **Post-migration transformacija**:
   - Pronalazi sve dokumente sa `RequiresTypeTransformation = true`
   - Grupira po `CoreId` i `DocumentType`
   - Za svaku grupu: nalazi najnoviji dokument (po `OriginalCreatedAt`)
   - Transformi≈°e tip: `00824-migracija` ‚Üí `00099`
   - Postavlja kao aktivan: `IsActive = true`

3. **Dokumenti sa "novi dokument" policy**:
   - Migriraju se bez sufiksa
   - Ostaju aktivni ako su bili aktivni u starom sistemu
   - Ne trebaju post-migration transformaciju

### KDP Document Handling
Per dokumentacija linija 41-72, 121-129:

1. **Account Number Enrichment**:
   - Samo za KDP dokumente: `00099`, `00824`, `00101`, `00825`, `00100`, `00827`
   - Uzimaju se raƒçuni koji su bili **aktivni na datum kreiranja dokumenta**
   - Format: CSV string (`"12345,67890,11111"`)
   - Poziv: `ClientAPI.GetActiveAccountsAsync(CoreId, OriginalCreatedAt)`

2. **Activity Status**:
   - Za isti CoreId + isti tip dokumenta: samo najnoviji je aktivan
   - Stariji dokumenti se postavljaju kao neaktivni
   - Posebno komplikovana logika za razliƒçite tipove KDP dokumenata

### Unique Folder Identifiers
Per dokumentacija linija 156-163:

1. **Parent Folder** (Referenca):
   - Format: `DE-{CoreId}{ProductType}-{ContractNumber}`
   - Primer: `DE-1019430200008-10104302`
   - **Nema separatora** izmeƒëu CoreId i ProductType!

2. **Subfolder** (Jedinstveni identifikator):
   - Format: `DE-{CoreId}-{ProductType}-{ContractNumber}_{Timestamp}`
   - Primer: `DE-10194302-00008-10104302_20241105154459`
   - Timestamp: `yyyyMMddHHmmss` (14 cifara)
   - **Ima separator** (`-`) izmeƒëu CoreId i ProductType

3. **Validacija**:
   - ProductType mora biti **taƒçno 5 cifara** (`00008`, `00010`)
   - CoreId mora biti numeriƒçki
   - ContractNumber obavezan

### Date Handling - VA≈ΩNO!
Per dokumentacija linija 190-194:

1. **OriginalCreatedAt** (DOC_STAGING):
   - **NE** datum migracije!
   - Datum kada je dokument arhiviran u **starom Alfresco**
   - Koristi se za account enrichment i activity determination

2. **ProcessDate** (FOLDER_STAGING):
   - **NE** datum migracije!
   - Datum kada je depozit **procesuiran** (iz DUT `ProcessedAt` ili `CreatedAt`)
   - Koristi se za generisanje `UniqueIdentifier` timestamp-a

---

## ‚ö†Ô∏è Poznata Ograniƒçenja i TODO

### 1. Repository Methods (TODO)
Sledeƒáe metode treba dodati u `IDocStagingRepository`:

```csharp
Task<List<DocStaging>> GetDocumentsRequiringTransformationAsync(CancellationToken ct);
Task<List<DocStaging>> GetKdpDocumentsWithoutAccountsAsync(CancellationToken ct);
Task UpdateAsync(DocStaging document, CancellationToken ct);
Task<int> CountDocumentsWithoutCoreIdAsync(CancellationToken ct);
Task<int> CountUntransformedDocumentsAsync(CancellationToken ct);
Task<int> CountKdpDocumentsWithoutAccountsAsync(CancellationToken ct);
Task<int> CountDocumentsByStatusAsync(string status, CancellationToken ct);
```

### 2. Business Mapping Table
`TypeMappings` dictionary u `DocumentTypeTransformationService` sadr≈æi samo primere iz dokumentacije. Treba a≈æurirati sa kompletnim mapiranjima iz:
**"Analiza_za_migr_novo ‚Äì mapiranje v3.xlsx"**
- Kolona C: migration type
- Kolona G: final type

### 3. DocumentActivityStatusService (Nije Implementiran)
Kompleksna logika za odreƒëivanje aktivnosti KDP dokumenata (linija 51-72 dokumentacije).
Odlo≈æeno zbog kompleksnosti - zahteva:
- Grupovanje po CoreId + DocumentType
- Pronala≈æenje najnovijeg dokumenta
- Validacija raƒçuna
- Posebna pravila za razliƒçite tipove

### 4. Deposit Matching Bez Contract Number
Per dokumentacija linija 196-202:
- Ako dokument nema `ContractNumber`
- Matching po: `CoreId` + `DepositDate` iz DUT `OfferBO`
- Ako ima vi≈°e ponuda: **potrebno ruƒçno matching**
- Trenutno: loguje warning u `DutApi.FindOffersByDateAsync()`

---

## üìä Statistika Implementacije

| Kategorija | Broj |
|------------|------|
| **Interfejsi** | 5 |
| **Implementacije** | 5 |
| **Data Modeli** | 7 |
| **Configuration Klase** | 2 |
| **Pro≈°irenja Postojeƒáih Modela** | 2 |
| **SQL Skripte** | 1 (sa 36 novih kolona) |
| **PowerShell Skripte** | 1 |
| **Dokumenti** | 8 |
| **Post-Migration Tools** | 1 |
| **Service Registrations** | 5 (commented) |
| **Total Lines of Code** | ~3500+ |
| **Total Fajlova Kreirano/A≈æurirano** | 28 |

---

## ‚úÖ Checklist Pre Production

### Pre SQL Migracije:
- [ ] Backup baze podataka
- [ ] Testiraj SQL skriptu na DEV environmentu
- [ ] Verifikuj indekse (11 novih)
- [ ] Proveri kolone (16 za DOC_STAGING, 20 za FOLDER_STAGING)

### Pre Omoguƒáavanja API Integracije:
- [ ] Dobijte pristup ClientAPI (URL, API key)
- [ ] Dobijte pristup DUT API (URL, API key)
- [ ] Testirajte API konekcije ruƒçno (Postman/curl)
- [ ] Konfiguri≈°i `appsettings.json` ili User Secrets
- [ ] Odkomentari≈°i service registrations u `App.xaml.cs`
- [ ] Odkomentari≈°i integration kod u servisima

### Tokom Migracije:
- [ ] Pokreni sa malim batch-om (10-50 dokumenata)
- [ ] Verifikuj ClientAPI enrichment u staging tabelama
- [ ] Verifikuj document type determination
- [ ] Prati log-ove za gre≈°ke
- [ ] Proveri performanse (API response time)

### Nakon Migracije:
- [ ] Pokreni document type transformation
- [ ] Pokreni KDP account enrichment
- [ ] Pokreni validation
- [ ] Pregledaj validation report
- [ ] Verifikuj random sample dokumenata ruƒçno

---

## üìû Za Pomoƒá

### Gre≈°ke u SQL Migraciji:
‚Üí Pogledaj `SQL/RUN_MIGRATION.md` ‚Üí Troubleshooting sekcija

### Gre≈°ke u API Integraciji:
‚Üí Pogledaj `INTEGRATION_INSTRUCTIONS.md` ‚Üí Troubleshooting sekcija

### Business Logic Pitanja:
‚Üí Pogledaj `Migracija_dokumentacija.txt` za originalne zahteve
‚Üí Pogledaj `IMPLEMENTATION_SUMMARY.md` za detaljne referencecascade

### Kako Dodati Novi Document Type Mapping:
‚Üí A≈æuriraj `TypeMappings` dictionary u `DocumentTypeTransformationService.cs`

---

## üéØ ≈†ta Dalje?

1. **Odmah**: Pokreni SQL migraciju
2. **Kad dobije≈° API pristup**: Odkomentari≈°i i konfiguri≈°i
3. **Testiraj**: Mali batch prvo
4. **Migracija**: Sve izvore (Heimdall, DUT, old DMS)
5. **Post-Migration**: Transform, Enrich, Validate

---

**Sve je spremno i ƒçeka samo pristup eksternim API-jima!** üöÄ
