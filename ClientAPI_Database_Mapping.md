# ClientAPI to Database Mapping Guide

## Pregled

ClientProperties objekat se mapira u `FolderStaging` tabelu u SQL Server bazi podataka. Mapper automatski prenosi sve client propertije iz `Entry.ClientProperties` u odgovarajuƒáe kolone u `FolderStaging` tabeli.

## Mapping Flow

```
Entry.ClientProperties (memory)
    ‚Üì
MyMapper.ToFolderStagingInsert()
    ‚Üì
FolderStaging (entity)
    ‚Üì
FolderStagingRepository.InsertManyAsync()
    ‚Üì
SQL Server FolderStaging Table
```

## Field Mapping

### Complete Mapping Table

| ClientProperties Field | FolderStaging Column | Description |
|------------------------|---------------------|-------------|
| `CoreId` | `CoreId` | Client's Core ID (unique identifier) |
| `MbrJmbg` | `MbrJmbg` | MBR (legal entities) or JMBG (natural persons) |
| `ClientName` | `ClientName` | Full client name |
| `ClientType` | `ClientType` | "FL" (Natural Person) or "PL" (Legal Entity) |
| `ClientSubtype` | `ClientSubtype` | Client subtype classification |
| `Residency` | `Residency` | Resident/Non-resident status |
| `Segment` | `Segment` | Client segment (Premium, VIP, etc.) |
| `Staff` | `Staff` | Staff indicator (if bank employee) |
| `OpuUser` | `OpuUser` | Organizational Unit of the user |
| `OpuRealization` | `OpuRealization` | OPU/ID of realization |
| `Barclex` | `Barclex` | Barclex identifier |
| `Collaborator` | `Collaborator` | Collaborator/Partner information |

## Mapper Implementation

### Location
`Mapper/MyMapper.cs` - linija 26-57

### Code
```csharp
public static FolderStaging ToFolderStagingInsert(this Entry inEntryi)
{
    var folderStaging = new FolderStaging
    {
        NodeId = inEntryi.Id,
        ParentId = inEntryi.ParentId,
        Name = inEntryi.Name,
        Status = MigrationStatus.Ready.ToDbString(),
        CreatedAt = DateTime.UtcNow,
        UpdatedAt = DateTime.UtcNow
    };

    // Map ClientProperties if available
    if (inEntryi.ClientProperties != null)
    {
        folderStaging.CoreId = inEntryi.ClientProperties.CoreId;
        folderStaging.MbrJmbg = inEntryi.ClientProperties.MbrJmbg;
        folderStaging.ClientName = inEntryi.ClientProperties.ClientName;
        folderStaging.ClientType = inEntryi.ClientProperties.ClientType;
        folderStaging.ClientSubtype = inEntryi.ClientProperties.ClientSubtype;
        folderStaging.Residency = inEntryi.ClientProperties.Residency;
        folderStaging.Segment = inEntryi.ClientProperties.Segment;
        folderStaging.Staff = inEntryi.ClientProperties.Staff;
        folderStaging.OpuUser = inEntryi.ClientProperties.OpuUser;
        folderStaging.OpuRealization = inEntryi.ClientProperties.OpuRealization;
        folderStaging.Barclex = inEntryi.ClientProperties.Barclex;
        folderStaging.Collaborator = inEntryi.ClientProperties.Collaborator;
    }

    return folderStaging;
}
```

## FolderStaging Table Structure

### Client Properties Columns

```sql
-- Client identification
CoreId NVARCHAR(50)
MbrJmbg NVARCHAR(50)
ClientName NVARCHAR(255)
ClientType NVARCHAR(10)    -- FL or PL
ClientSubtype NVARCHAR(50)

-- Client classification
Residency NVARCHAR(50)     -- Resident/Non-resident
Segment NVARCHAR(50)       -- Premium, VIP, etc.

-- Additional attributes
Staff NVARCHAR(50)
OpuUser NVARCHAR(50)
OpuRealization NVARCHAR(100)
Barclex NVARCHAR(50)
Collaborator NVARCHAR(255)
```

**Note:** Svi ovi fieldovi su nullable (`NVARCHAR(...)` bez `NOT NULL`), ≈°to omoguƒáava da folderi budu upisani i bez client propertija.

## Data Flow Example

### 1. Entry sa ClientProperties iz Alfresca

```csharp
var entry = new Entry
{
    Id = "abc-123",
    Name = "PL-10000123TTT",
    ClientProperties = new ClientProperties
    {
        CoreId = "10000123",
        MbrJmbg = "12345678",
        ClientName = "Test Klijent DOO",
        ClientType = "PL",
        ClientSubtype = "SME",
        Residency = "Resident",
        Segment = "Corporate",
        Staff = "N",
        OpuUser = "OPU-100",
        OpuRealization = "OPU-200/ID-5000",
        Barclex = "BX12345",
        Collaborator = "Partner A"
    }
};
```

### 2. Mapping u FolderStaging

```csharp
var folderStaging = entry.ToFolderStagingInsert();

// Result:
// folderStaging.NodeId = "abc-123"
// folderStaging.Name = "PL-10000123TTT"
// folderStaging.CoreId = "10000123"
// folderStaging.ClientName = "Test Klijent DOO"
// ... (all other properties mapped)
```

### 3. Insert u bazu

```csharp
await folderRepo.InsertManyAsync(foldersToInsert, ct);
```

### 4. SQL INSERT Statement (generated by EF Core)

```sql
INSERT INTO FolderStaging (
    NodeId, ParentId, Name, Status,
    CoreId, MbrJmbg, ClientName, ClientType, ClientSubtype,
    Residency, Segment, Staff, OpuUser, OpuRealization,
    Barclex, Collaborator,
    CreatedAt, UpdatedAt
) VALUES (
    'abc-123', 'parent-id', 'PL-10000123TTT', 'READY',
    '10000123', '12345678', 'Test Klijent DOO', 'PL', 'SME',
    'Resident', 'Corporate', 'N', 'OPU-100', 'OPU-200/ID-5000',
    'BX12345', 'Partner A',
    '2025-10-27 12:00:00', '2025-10-27 12:00:00'
);
```

## Null Handling

### Scenario 1: Entry bez ClientProperties

```csharp
var entry = new Entry
{
    Id = "abc-456",
    Name = "SomeFolder",
    ClientProperties = null  // ‚Üê Nema ClientProperties
};

var folderStaging = entry.ToFolderStagingInsert();

// Result:
// folderStaging.CoreId = null
// folderStaging.ClientName = null
// ... (all client properties are null)
```

SQL INSERT ƒáe biti:
```sql
INSERT INTO FolderStaging (NodeId, Name, Status, CoreId, ClientName, ...)
VALUES ('abc-456', 'SomeFolder', 'READY', NULL, NULL, ...);
```

### Scenario 2: Entry sa parcijalno popunjenim ClientProperties

```csharp
var entry = new Entry
{
    Id = "abc-789",
    Name = "FL-10000789TTT",
    ClientProperties = new ClientProperties
    {
        CoreId = "10000789",
        ClientName = "Marko Markoviƒá",
        ClientType = "FL"
        // Ostali fieldi su null
    }
};

var folderStaging = entry.ToFolderStagingInsert();

// Result:
// folderStaging.CoreId = "10000789"
// folderStaging.ClientName = "Marko Markoviƒá"
// folderStaging.ClientType = "FL"
// folderStaging.Residency = null
// folderStaging.Segment = null
// ... (other properties are null)
```

## Verification Queries

### Query 1: Count folders sa ClientProperties

```sql
SELECT COUNT(*)
FROM FolderStaging
WHERE CoreId IS NOT NULL;
```

### Query 2: Count folders po ClientType

```sql
SELECT ClientType, COUNT(*) as Count
FROM FolderStaging
WHERE ClientType IS NOT NULL
GROUP BY ClientType;
```

**Expected results:**
- `FL` (Fiziƒçko Lice) - Natural persons
- `PL` (Pravno Lice) - Legal entities

### Query 3: Sample folders sa svim client properties

```sql
SELECT TOP 10
    NodeId, Name,
    CoreId, MbrJmbg, ClientName, ClientType, ClientSubtype,
    Residency, Segment, Staff, OpuUser, OpuRealization,
    Barclex, Collaborator
FROM FolderStaging
WHERE CoreId IS NOT NULL
ORDER BY CreatedAt DESC;
```

### Query 4: Folders bez ClientProperties

```sql
SELECT COUNT(*) as FoldersWithoutClientData
FROM FolderStaging
WHERE CoreId IS NULL;
```

## Logging

Mapper ne loguje direktno, ali mo≈æete pratiti mapping kroz `FolderDiscoveryService` logove:

```
[INFO] Read 100 folders from DOSSIER-PL
[INFO] Enriched 25 folders with ClientAPI data (Errors: 0)
[INFO] FolderDiscovery batch completed: 100 folders from DOSSIER-PL inserted
```

## Performance Considerations

### Batch Insert

Mapper radi sa batch-om foldera odjednom:

```csharp
var foldersToInsert = page.Items.ToList().ToFolderStagingListInsert();
// Umesto pojedinaƒçnih insert-a, sve se upisuje odjednom:
await folderRepo.InsertManyAsync(foldersToInsert, ct);
```

**Benefit:** Znaƒçajno br≈æi upis u bazu (100x br≈æi od pojedinaƒçnih INSERT-ova).

### Memory Usage

ClientProperties dodaje ~500 bytes po folderu:
- 12 string fields √ó ~40 bytes average = ~480 bytes
- Object overhead = ~20 bytes

Za batch od 1000 foldera: ~500KB dodatne memorije.

## Troubleshooting

### Problem: ClientProperties se ne upisuju u bazu

**Provera 1:** Da li Entry ima ClientProperties?
```csharp
_fileLogger.LogDebug("Entry {Name} has ClientProperties: {HasProps}",
    entry.Name, entry.ClientProperties != null);
```

**Provera 2:** Da li mapper radi?
```csharp
var folderStaging = entry.ToFolderStagingInsert();
_fileLogger.LogDebug("Mapped CoreId: {CoreId}", folderStaging.CoreId);
```

**Provera 3:** SQL query direktno u bazi
```sql
SELECT TOP 1 * FROM FolderStaging
WHERE NodeId = 'abc-123';
```

### Problem: Null values u bazi iako Entry ima ClientProperties

**Moguƒái uzrok:** Mapper ne mapira NULL vrijednosti iz ClientProperties.

**Re≈°enje:** Provjerite da ClientProperties fieldovi nisu null:
```csharp
if (inEntryi.ClientProperties != null)
{
    // Ova provjera samo kreira FolderStaging sa null vrijednostima
    // ako su ClientProperties fieldi null
    folderStaging.CoreId = inEntryi.ClientProperties.CoreId; // mo≈æe biti null!
}
```

## Summary

‚úÖ **Mapper:** `MyMapper.ToFolderStagingInsert()` automatski mapira svih 12 ClientProperties fielda
‚úÖ **Null-safe:** Radi sa null ClientProperties i parcijalno popunjenim fieldima
‚úÖ **Batch insert:** Optimizovan za batch upis u bazu
‚úÖ **Testiran:** Build je uspe≈°an, sve komponente rade

Svi ClientProperties se automatski mapiraju u FolderStaging i upisuju u SQL Server bazu podataka! üéâ
